version: 2
jobs:
  build:
    working_directory: ~/lunchagator-server
    docker:
      - image: openjdk:8
    steps:
      - checkout
      - run: ./gradlew build
#      - save_cache:
#          paths:
#            - ~/.m2
#          key: {{ checksum "build.gradle" }}
      - store_artifacts:
          path: build/libs/lunchagator-server-0.0.1-SNAPSHOT.jar
          destination: das-app.jar
      - setup_remote_docker
      - run:
         name: Install Docker client
         command: |
           set -x
           VER="17.03.0-ce"
           curl -L -o /tmp/docker-$VER.tgz https://get.docker.com/builds/Linux/x86_64/docker-$VER.tgz
           tar -xz -C /tmp -f /tmp/docker-$VER.tgz
           mv /tmp/docker/* /usr/bin
      - run: |
         TAG=0.1.$CIRCLE_BUILD_NUM
         NAME=test:$TAG
         docker build -t $NAME
         docker login -u $DOCKER_USER -p $DOCKER_PASS
         docker push $NAME
